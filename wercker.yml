box: golang:1.4
build:
    steps:
        - setup-go-workspace

        - script:
            name: install actool
            code: |
                wget -O appc.tar.gz https://github.com/appc/spec/releases/download/v0.7.1/appc-v0.7.1.tar.gz
                tar -xzf appc.tar.gz --strip 1 --wildcards --no-anchored 'actool'
                rm -rf appc.tar.gz

        - script:
            name: install confd
            code: |
                wget -O confd https://github.com/kelseyhightower/confd/releases/download/v0.10.0/confd-0.10.0-linux-amd64
                chmod +x confd

        - script:
            name: install deb2aci
            code: |
                git clone https://github.com/klizhentas/deb2aci.git src/github.com/klizhentas/deb2aci
                cd src/github.com/klizhentas/deb2aci
                go get ./...
                go install
                cd ../../../../
                mv bin/deb2aci ./
                rm -rf bin pkg src

        - script:
            name: build aci
            code: |
                ./deb2aci nginx nginx.aci nginx.manifest
                #TODO
                mv nginx.aci kubernetes-proxy.aci

    after-steps:
        - slack-notifier:
            url: $SLACK_URL
            username: wercker

deploy:
    steps:
        - github-create-release:
            token: $GITHUB_TOKEN
            tag: v0.0.1

        - github-upload-asset:
            token: $GITHUB_TOKEN
            file: kubernetes-proxy.aci

    after-steps:
        - slack-notifier:
            url: $SLACK_URL
            username: wercker

box: ubuntu:latest
build:
    steps:
        - script:
            name: echo
            code: echo "Nothing to do here"
deploy:
    steps:
        - install-packages:
            packages: curl git golang-go tar wget

        - script:
            name: export GOPATH
            code: export GOPATH=/usr/local/lib/go

        - setup-go-workspace

        - script:
            name: install actool
            code: |
                wget -O appc.tar.gz https://github.com/appc/spec/releases/download/v0.7.1/appc-v0.7.1.tar.gz
                tar -xzf appc.tar.gz --strip 1 --wildcards \
                    --no-anchored 'actool'
                rm -rf appc.tar.gz
                mv actool /usr/local/bin/actool

        - script:
            name: install confd
            code: |
                wget -O confd https://github.com/kelseyhightower/confd/releases/download/v0.10.0/confd-0.10.0-linux-amd64
                chmod +x confd

        - script:
            name: install deb2aci
            code: |
                git clone https://github.com/klizhentas/deb2aci.git \
                    src/github.com/klizhentas/deb2aci
                cd src/github.com/klizhentas/deb2aci
                go get -v ./...
                go build -v
                mv $GOPATH/bin/deb2aci /usr/local/bin/deb2aci

        - script:
            name: build aci
            code: |
                # Base image
                deb2aci -pkg bash -pkg libtinfo5 -pkg nginx \
                    -image kubernetes-proxy.aci \
                    -manifest kubernetes-proxy.manifest.json
                mkdir aci
                tar -xf kubernetes-proxy.aci -C aci/
                rm -rf kubernetes-proxy.aci

                # Setup Confd
                mkdir -p aci/rootfs/etc/confd/
                mv confd aci/rootfs/usr/bin/confd
                mv conf.d aci/rootfs/etc/confd/conf.d
                mv templates aci/rootfs/etc/confd/templates

                # Setup Nginx
                rm -rf aci/rootfs/etc/nginx/conf.d/*
                ln -sf /dev/stdout aci/rootfs/var/log/nginx/access.log
                ln -sf /dev/stderr aci/rootfs/var/log/nginx/error.log

                # Setup Boot script
                mv scripts/boot.sh aci/rootfs/usr/bin/boot.sh

                # Pack ACI
                actool build aci/ kubernetes-proxy.aci

        - github-create-release:
            token: $GITHUB_TOKEN
            tag: v0.0.1

        - github-upload-asset:
            token: $GITHUB_TOKEN
            file: kubernetes-proxy.aci

    after-steps:
        - slack-notifier:
            url: $SLACK_URL
            username: wercker
